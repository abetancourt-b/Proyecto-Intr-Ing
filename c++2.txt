#include <WiFi.h>
#include <time.h>

// BMP280
#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BMP280.h>

// SDS011
#include <SDS011.h>

// Firebase
#include "FirebaseESP32.h"
#include <addons/TokenHelper.h>
#include <addons/RTDBHelper.h>

// --------------------------
// CONFIG WiFi y Firebase
// --------------------------
#define WIFI_SSID "repetidor"
#define WIFI_PASSWORD "39727675"

#define API_KEY "AIzaSyAkZoxB2TfujfWVu_8AttZWKNKZqvSY8D4"
#define DATABASE_URL "https://estacion-de-monitoreo-b2335-default-rtdb.firebaseio.com"
#define USER_EMAIL "esp32@test.com"
#define USER_PASSWORD "123456789"

FirebaseData fb;
FirebaseAuth auth;
FirebaseConfig config;

// --------------------------
// Sensores
// --------------------------
Adafruit_BMP280 bmp;
const int MQ135_PIN = 34;

// SDS011
SDS011 sds;
float pm25, pm10;

// --------------------------
// Pines
// --------------------------
const int RED = 25;
const int BLUE = 26;
const int GREEN = 27;
const int Buzzer = 32;

// --------------------------
// NTP
// --------------------------
const char* ntpServer = "pool.ntp.org";
const long gmtOffset_sec = -18000;
const int daylightOffset_sec = 0;

// --------------------------
// Función timestamp epoch
// --------------------------
unsigned long getEpoch() {
  return millis() + 0; 
}

// --------------------------
void setup() {
  Serial.begin(115200);

  // WIFI
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }
  Serial.println("WiFi OK");

  // NTP
  configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);

  // BMP280
  if (!bmp.begin(0x76)) {
    Serial.println("ERROR: BMP280 no encontrado");
    while (1);
  }

  // SDS011 (UART2 en ESP32)
  sds.begin(16, 17); // RX=16, TX=17

  pinMode(RED, 1);
  pinMode(BLUE, 1);
  pinMode(GREEN,1);
  pinMode(Buzzer,1);

  // Firebase
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;
  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;

  Firebase.begin(&config, &auth);
  while (!Firebase.ready()) delay(200);

  Serial.println("Firebase OK");
}

void loop() {

  // --------------------------
  // HEARTBEAT (estado)
  // --------------------------
  Firebase.setInt(fb, "/estado/heartbeat", millis());

  // --------------------------
  // MQ135
  // --------------------------
  int raw = analogRead(MQ135_PIN);
  float ppm = raw * (3.3 / 4095.0) * 100;  // simple estimación básica

  // riesgo MQ135
  String risk_mq = 
    ppm < 150 ? "bajo" :
    ppm < 300 ? "medio" : "alto";

  // enviar
  Firebase.setFloat(fb, "/sensores/MQ135/valor", ppm);
  Firebase.setString(fb, "/sensores/MQ135/unidad", "ppm");
  Firebase.setString(fb, "/sensores/MQ135/riesgo", risk_mq);
  Firebase.setInt(fb, "/sensores/MQ135/timestamp", millis());

  // --------------------------
  // SDS011
  // --------------------------
  int err = sds.read(&pm25, &pm10);

  if (!err) {
    String risk_pm = 
      pm25 < 35 ? "bajo" :
      pm25 < 75 ? "medio" : "alto";

    Firebase.setFloat(fb, "/sensores/SDS011/pm25", pm25);
    Firebase.setFloat(fb, "/sensores/SDS011/pm10", pm10);
    Firebase.setString(fb, "/sensores/SDS011/riesgo", risk_pm);
    Firebase.setInt(fb, "/sensores/SDS011/timestamp", millis());
  }

  // --------------------------
  // BMP280
  // --------------------------
  float temp = bmp.readTemperature();
  float pres = bmp.readPressure() / 100.0F;

  Firebase.setFloat(fb, "/sensores/BMP280/temperatura", temp);
  Firebase.setFloat(fb, "/sensores/BMP280/presion_hPa", pres);
  Firebase.setInt(fb, "/sensores/BMP280/timestamp", millis());

  // --------------------------
  // ALERTAS
  // --------------------------
  if (temp < 25) {
    digitalWrite(RED, HIGH);
    digitalWrite(BLUE, HIGH);
    digitalWrite(GREEN, LOW);
    digitalWrite(Buzzer, LOW);
  }
  else if (temp <= 27) {
    digitalWrite(RED, HIGH);
    digitalWrite(BLUE, LOW);
    digitalWrite(GREEN, HIGH);
    digitalWrite(Buzzer, LOW);
  }
  else {
    digitalWrite(RED, LOW);
    digitalWrite(BLUE, HIGH);
    digitalWrite(GREEN, HIGH);
    digitalWrite(Buzzer, HIGH);
  }

  delay(2000);
}
